import { createRouter, createWebHistory } from 'vue-router';
import { useEntitlementsStore } from '@/shared/stores/entitlements';
import type { RouteRecordRaw } from 'vue-router';
import type { FeatureCode } from "@/modules/marketplace/types.ts";

// Страницы
import LoginPage from '../modules/auth/pages/LoginPage.vue';
import DashboardPage from '../modules/dashboard/pages/DashboardPage.vue';
import AppLayout from '../shared/layout/AppLayout.vue';
import DealsPage from '../modules/deals/pages/DealsPage.vue'
import { useAuthStore } from '../modules/auth/stores/useAuthStore.ts';
import MarketplacePage  from "../modules/marketplace/pages/MarketplacePage.vue";
import CurrencyPage from "../modules/currency/pages/CurrencyPage.vue";

const routes: RouteRecordRaw[] = [
    {
        path: '/',
        redirect: '/app/login',
    },
    {
        path: '/app/login',
        name: 'login',
        component: LoginPage,
    },
    {
        path: '/app',
        component: AppLayout,
        children: [
            {
                path: 'dashboard',
                name: 'dashboard',
                component: DashboardPage,
            },
            {
                path: 'deals',
                name: 'deals',
                component: DealsPage,
            },
            {
                path: 'marketplace',
                name: 'marketplace',
                component: MarketplacePage,
            },
            {
                path: 'currency',
                name: 'currency',
                component: CurrencyPage,
                meta: { feature: 'CURRENCY' }
            },
            // позже сюда добавим /clients, /modules, /chat, /reports, /settings
        ],
    },
];

const router = createRouter({
    history: createWebHistory(import.meta.env.BASE_URL),
    routes,
});

// Глобальный guard для защиты маршрутов.
router.beforeEach((to, from, next) => {
    const authStore = useAuthStore();

    const isAuth = authStore.isAuthenticated;
    const isLoginPage = to.name === 'login';

    // Если пользователь не авторизован и идёт куда-то в /app, кроме /app/login
    if (!isAuth && to.path.startsWith('/app') && !isLoginPage) {
        next({ name: 'login' });
    }

    // Если пользователь авторизован и пытается зайти на /app/login —
    // отправляем его на дашборд.
    if (isAuth && isLoginPage) {
        next({ name: 'dashboard' });
    }

    // Во всех остальных случаях просто продолжаем навигацию.
    next();
});

export default router;